const supabase = require('../config/supabase');
const { validateProduct, validateId } = require('../validators/productValidator');

// GET - Listar todos os produtos
exports.getAllProducts = async (req, res) => {
  try {
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    // Calcular economia para cada produto
    const productsWithSavings = data.map(product => ({
      ...product,
      savings: product.old_price - product.new_price
    }));

    res.status(200).json({
      success: true,
      count: productsWithSavings.length,
      data: productsWithSavings
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao buscar produtos',
      error: error.message
    });
  }
};

// GET - Buscar produto por ID
exports.getProductById = async (req, res) => {
  try {
    const { id } = req.params;

    // Validar ID
    if (!validateId(id)) {
      return res.status(400).json({
        success: false,
        message: 'ID inv치lido'
      });
    }

    const { data, error } = await supabase
      .from('products')
      .select('*')
      .eq('id', id)
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        return res.status(404).json({
          success: false,
          message: 'Produto n칚o encontrado'
        });
      }
      throw error;
    }

    // Adicionar economia
    const productWithSavings = {
      ...data,
      savings: data.old_price - data.new_price
    };

    res.status(200).json({
      success: true,
      data: productWithSavings
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao buscar produto',
      error: error.message
    });
  }
};

// POST - Criar novo produto
exports.createProduct = async (req, res) => {
  try {
    // Validar dados
    const validation = validateProduct(req.body);
    if (!validation.isValid) {
      return res.status(400).json({
        success: false,
        message: 'Dados inv치lidos',
        errors: validation.errors
      });
    }

    const { name, emoji, old_price, new_price, discount } = req.body;

    const { data, error } = await supabase
      .from('products')
      .insert([
        {
          name: name.trim(),
          emoji: emoji.trim(),
          old_price: parseFloat(old_price),
          new_price: parseFloat(new_price),
          discount: parseInt(discount)
        }
      ])
      .select()
      .single();

    if (error) throw error;

    res.status(201).json({
      success: true,
      message: 'Produto criado com sucesso!',
      data: data
    });
  } catch (error) {
    res.status(400).json({
      success: false,
      message: 'Erro ao criar produto',
      error: error.message
    });
  }
};

// PUT - Atualizar produto
exports.updateProduct = async (req, res) => {
  try {
    const { id } = req.params;

    // Validar ID
    if (!validateId(id)) {
      return res.status(400).json({
        success: false,
        message: 'ID inv치lido'
      });
    }

    // Validar dados (parcial)
    const validation = validateProduct({ ...req.body });
    if (!validation.isValid) {
      return res.status(400).json({
        success: false,
        message: 'Dados inv치lidos',
        errors: validation.errors
      });
    }

    // Preparar dados para atualiza칞칚o
    const updateData = {};
    if (req.body.name) updateData.name = req.body.name.trim();
    if (req.body.emoji) updateData.emoji = req.body.emoji.trim();
    if (req.body.old_price !== undefined) updateData.old_price = parseFloat(req.body.old_price);
    if (req.body.new_price !== undefined) updateData.new_price = parseFloat(req.body.new_price);
    if (req.body.discount !== undefined) updateData.discount = parseInt(req.body.discount);

    const { data, error } = await supabase
      .from('products')
      .update(updateData)
      .eq('id', id)
      .select()
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        return res.status(404).json({
          success: false,
          message: 'Produto n칚o encontrado'
        });
      }
      throw error;
    }

    res.status(200).json({
      success: true,
      message: 'Produto atualizado com sucesso!',
      data: data
    });
  } catch (error) {
    res.status(400).json({
      success: false,
      message: 'Erro ao atualizar produto',
      error: error.message
    });
  }
};

// DELETE - Deletar produto
exports.deleteProduct = async (req, res) => {
  try {
    const { id } = req.params;

    // Validar ID
    if (!validateId(id)) {
      return res.status(400).json({
        success: false,
        message: 'ID inv치lido'
      });
    }

    const { data, error } = await supabase
      .from('products')
      .delete()
      .eq('id', id)
      .select()
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        return res.status(404).json({
          success: false,
          message: 'Produto n칚o encontrado'
        });
      }
      throw error;
    }

    res.status(200).json({
      success: true,
      message: 'Produto deletado com sucesso!',
      data: data
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao deletar produto',
      error: error.message
    });
  }
};
/backend/src/routes crie o arquivo productRouters.js

const express = require('express');
const router = express.Router();
const productController = require('../controllers/productController');

// Rotas de produtos
router.get('/products', productController.getAllProducts);
router.get('/products/:id', productController.getProductById);
router.post('/products', productController.createProduct);
router.put('/products/:id', productController.updateProduct);
router.delete('/products/:id', productController.deleteProduct);

module.exports = router;
/backend/src/ crie o arquivo server.js

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const productRoutes = require('./routes/productRoutes');

const app = express();
const PORT = process.env.PORT || 3000;

// Middlewares
app.use(cors()); // Permitir requisi칞칫es do frontend
app.use(express.json()); // Parsear JSON no body
app.use(express.urlencoded({ extended: true })); // Parsear form data

// Rota de teste
app.get('/', (req, res) => {
  res.json({
    message: '游꿀 API Back Friday est치 funcionando!',
    version: '1.0.0',
    database: 'Supabase (PostgreSQL)',
    endpoints: {
      products: '/api/products'
    }
  });
});

// Rotas da API
app.use('/api', productRoutes);

// Middleware de erro 404
app.use((req, res) => {
  res.status(404).json({
    success: false,
    message: 'Rota n칚o encontrada'
  });
});

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`游 Servidor rodando na porta ${PORT}`);
  console.log(`游늸 http://localhost:${PORT}`);
});
